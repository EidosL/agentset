enum DocumentStatus {
  BACKLOG
  QUEUED
  QUEUED_FOR_RESYNC
  QUEUED_FOR_DELETE
  PRE_PROCESSING
  PROCESSING
  DELETING
  CANCELLING
  COMPLETED
  FAILED
  CANCELLED
}

model Document {
  id         String  @id @default(cuid())
  externalId String?
  name       String?
  tenantId   String?

  status DocumentStatus @default(BACKLOG)
  error  String?

  /// [DocumentSource]
  source Json

  /// [DocumentConfig]
  config Json?

  queuedAt        DateTime? @default(now())
  preProcessingAt DateTime?
  processingAt    DateTime?
  completedAt     DateTime?
  failedAt        DateTime?

  namespaceId String?
  namespace   Namespace? @relation(fields: [namespaceId], references: [id], onDelete: Cascade)

  ingestJobId String
  ingestJob   IngestJob @relation(fields: [ingestJobId], references: [id], onDelete: Cascade)

  workflowRunsIds String[] @default([])

  /// [DocumentProperties]
  documentProperties Json?

  totalChunks     Int   @default(0)
  totalTokens     Int   @default(0)
  totalCharacters Int   @default(0)
  totalPages      Float @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // externalId must be unique within a namespace
  @@unique([namespaceId, externalId])
  // indexing by namespaceId
  @@index([namespaceId])
  // filtering by status
  @@index([namespaceId, status])
  @@index([ingestJobId, status])
  @@index([ingestJobId, tenantId, status])
  @@index([namespaceId, tenantId, status])
  // filtering by tenant
  @@index([ingestJobId, tenantId])
  @@index([namespaceId, tenantId])
  @@map("document")
}
